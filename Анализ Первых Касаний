/**********************************************************
 * ÐÐÐÐ›Ð˜Ð— ÐŸÐ•Ð Ð’Ð«Ð¥ ÐšÐÐ¡ÐÐÐ˜Ð™ (v2.0: Ñ GPT Ð¸ Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð¾Ð¼)
 **********************************************************/
const FT_CFG = {
  RA_SHEET: 'Ð ÐÐ‘ÐžÐ§Ð˜Ð™ ÐÐœÐž',
  OUT_SHEET: 'ÐÐÐÐ›Ð˜Ð— ÐŸÐ•Ð Ð’Ð«Ð¥ ÐšÐÐ¡ÐÐÐ˜Ð™',
  FONT: 'Arial',
  GPT_MODEL: 'gpt-4o',

  COLORS: {
    PRIMARY: '#1E5AA7', SECONDARY: '#3AA655', ACCENT: '#E46C0A', HEADER: '#4a4a4a',
    CHART_PALETTE: ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#AB47BC', '#00ACC1']
  },
  
  SUCCESS_RE: /(Ð¾Ð¿Ð»Ð°Ñ‡|ÑƒÑÐ¿ÐµÑˆ.*Ð²\s*Ñ€Ð¿|ÑƒÑÐ¿ÐµÑˆ.*Ñ€ÐµÐ°Ð»Ð¸Ð·)/i,

  H: {
    ID:       ['ID','Ð¡Ð´ÐµÐ»ÐºÐ°.ID'], NAME: ['ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ','Ð¡Ð´ÐµÐ»ÐºÐ°'], MANAGER:  ['ÐžÑ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹'],
    STATUS:   ['Ð¡Ñ‚Ð°Ñ‚ÑƒÑ'], BUDGET:   ['Ð‘ÑŽÐ´Ð¶ÐµÑ‚'], CREATED:  ['Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ','DATE'],
    CLIENT:   ['Ð¤Ð˜Ðž','ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚','Ð˜Ð¼Ñ','ÐšÐ»Ð¸ÐµÐ½Ñ‚'], PHONE: ['Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½','ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚.Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½','Phone'],
    SRC_TEL:  ['R.Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¢Ð•Ð› ÑÐ´ÐµÐ»ÐºÐ¸'], UTM_S: ['UTM_SOURCE','utm_source'],
    UTM_M:    ['UTM_MEDIUM','utm_medium'], UTM_C: ['UTM_CAMPAIGN','utm_campaign'],
    SUM_RUB:  ['Ð¡ÑƒÐ¼Ð¼Ð° â‚½'],
  },

  MAP: {
    site: [/^osn[_\-]?tel$/i, /^site$/i, /^rp[_\-]?site$/i, /^direct$/i, /^Ð¿Ñ€ÑÐ¼/i],
    yandex: [/^ya[_\-]?tel$/i, /^ya[_\-]?map/i, /^yandex/i], gis2: [/^2gis/i, /^2gis[_\-]?tel/i],
    telegram: [/^bot[_\-]?tg$/i, /^tg$/i, /^telegram/i], vk: [/^vk/i],
  },

  CHANNEL_TITLE: {
    site: 'Ð¡Ð°Ð¹Ñ‚', yandex: 'Ð¯Ð½Ð´ÐµÐºÑ', gis2: '2Ð“Ð˜Ð¡',
    telegram: 'Telegram', vk: 'Ð’ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ðµ', other: 'Ð”Ñ€ÑƒÐ³Ð¾Ðµ',
  },
  DETAIL_LIMIT: 50
};

/* ==================== ÐŸÐ£Ð‘Ð›Ð˜Ð§ÐÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ ==================== */
function buildFirstTouchReport(){
  const OPENAI_API_KEY = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  if (!OPENAI_API_KEY) throw new Error('ÐšÐ»ÑŽÑ‡ "OPENAI_API_KEY" Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð¡Ð²Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ… ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°.');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(FT_CFG.RA_SHEET);
  if (!sh) throw new Error('ÐÐµÑ‚ Ð»Ð¸ÑÑ‚Ð° "'+FT_CFG.RA_SHEET+'"');

  const {header, rows} = ft_readTable(sh);
  const idx = ft_getIdx(header);

  const byClient = ft_collectClientData(rows, idx);
  const { channels, details } = ft_aggregateChannelData(byClient);

  const sumRows = [...channels.values()]
    .sort((a,b)=>b.revenue - a.revenue)
    .map(v => {
      const conv = ft_pct(v.converted, v.firstCount);
      const ltv  = v.converted ? v.revenue / v.converted : 0;
      const grade = ft_effGrade(conv, ltv);
      return { ...v, conv, ltv, grade };
    });

  const detRows = details
    .sort((a,b) => (b.date || 0) - (a.date || 0))
    .slice(0, FT_CFG.DETAIL_LIMIT);

  const gptSummary = ft_getGptSummary(sumRows, OPENAI_API_KEY);

  ft_writeOutputSheet(ss, sumRows, detRows, gptSummary);
}

/* ==================== Ð’Ð«Ð’ÐžÐ” ÐÐ Ð›Ð˜Ð¡Ð¢ ==================== */
function ft_writeOutputSheet(ss, summaryData, detailData, gptSummary) {
  const out = ss.getSheetByName(FT_CFG.OUT_SHEET) || ss.insertSheet(FT_CFG.OUT_SHEET);
  out.clear();
  out.getCharts().forEach(chart => out.removeChart(chart));
  if(out.getMaxColumns() > 10) out.deleteColumns(11, out.getMaxColumns() - 10);
  if(out.getMaxRows() > 100) out.deleteRows(101, out.getMaxRows() - 100);
  ft_setFont(out, FT_CFG.FONT);

  let r=1, c=1;

  ft_band(out, r, c, 1, 10, FT_CFG.COLORS.HEADER);
  out.getRange(r, c, 1, 10).merge().setValue('ðŸ¥‡ ÐÐÐÐ›Ð˜Ð— ÐŸÐ•Ð Ð’Ð«Ð¥ ÐšÐÐ¡ÐÐÐ˜Ð™ ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐ’')
    .setFontColor('#fff').setFontSize(18).setFontWeight('bold');
  r++;
  out.getRange(r, 1).setValue(`ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾Ñ‚ ${new Date().toLocaleString('ru-RU')}`).setFontStyle('italic');
  r+=2;

  ft_buildDashboard(out, r, summaryData);
  r += 16;

  ft_title(out, r, c, ' EXECUTIVE SUMMARY (Ð¾Ñ‚ GPT)', 10, '#434343'); r++;
  out.getRange(r, c, 1, 10).merge().setValue(gptSummary).setWrap(true)
     .setVerticalAlignment('top').setBackground('#f8f9fa').setBorder(true,true,true,true,true,true);
  r += 4;

  ft_title(out, r, c, 'ðŸ“Š Ð­Ð¤Ð¤Ð•ÐšÐ¢Ð˜Ð’ÐÐžÐ¡Ð¢Ð¬ ÐšÐÐÐÐ›ÐžÐ’ ÐŸÐ•Ð Ð’ÐžÐ“Ðž ÐšÐÐ¡ÐÐÐ˜Ð¯', 10, FT_CFG.COLORS.PRIMARY); r++;
  const head1 = ['ÐšÐ°Ð½Ð°Ð»','ÐŸÐµÑ€Ð²Ñ‹Ñ… ÐºÐ°ÑÐ°Ð½Ð¸Ð¹','ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ÑÑŒ','ÐžÐ±Ñ‰Ð¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ â‚½','ÐšÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ','LTV â‚½','Ð­Ñ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ'];
  const body1 = summaryData.map(v => [v.title, v.firstCount, v.converted, v.revenue, v.conv, v.ltv, v.grade]);
  ft_writeTable(out, r, c, head1, body1);
  const n1 = Math.max(1, body1.length);
  out.getRange(r+1, c+3, n1, 1).setNumberFormat('#,##0" â‚½"');
  out.getRange(r+1, c+4, n1, 1).setNumberFormat('0.0%');
  out.getRange(r+1, c+5, n1, 1).setNumberFormat('#,##0" â‚½"');
  ft_applyConditionalFormatting(out.getRange(r+1, c+6, n1, 1));
  r += (n1 + 3);

  ft_title(out, r, c, 'ðŸ”Ž Ð”Ð•Ð¢ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ÐŸÐ•Ð Ð’Ð«Ð¥ ÐšÐÐ¡ÐÐÐ˜Ð™ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ' + FT_CFG.DETAIL_LIMIT + ')', 10, FT_CFG.COLORS.ACCENT); r++;
  const head2 = ['Ð”Ð°Ñ‚Ð°','ÐšÐ»Ð¸ÐµÐ½Ñ‚','Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½','ÐšÐ°Ð½Ð°Ð»','Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº','UTM','Ð’ÑÐµÐ³Ð¾ ÑÐ´ÐµÐ»Ð¾Ðº','ÐžÐ±Ñ‰Ð¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ â‚½'];
  const body2 = detailData.map(d=>[ d.date, d.client, d.phone, d.chTitle, d.source, d.utm, d.dealsCount, d.revenue ]);
  ft_writeTable(out, r, c, head2, body2);
  const n2 = Math.max(1, body2.length);
  out.getRange(r+1, c, n2, 1).setNumberFormat('dd.MM.yyyy');
  out.getRange(r+1, c+7, n2, 1).setNumberFormat('#,##0" â‚½"');
  
  ft_formatSheet(out);
}


/* ==================== Ð¡Ð‘ÐžÐ  Ð˜ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ Ð”ÐÐÐÐ«Ð¥ ==================== */
function ft_collectClientData(rows, idx) {
  const byClient = new Map();
  rows.forEach(r=>{
    const created = r[idx.CREATED] || '';
    const client  = String(r[idx.CLIENT] || '').trim() || 'â€”';
    const phone   = ft_cleanPhone(r[idx.PHONE]);
    if (!phone && client === 'â€”') return;
    const key     = (phone || client).toLowerCase();
    const status  = String(r[idx.STATUS]||'');
    const success = FT_CFG.SUCCESS_RE.test(status);
    const ax      = ft_money(r[idx.SUM_RUB]);
    const budget  = ft_money(r[idx.BUDGET]);
    const revenue = success ? (ax>0 ? ax : budget) : 0;
    const srcTel  = String(r[idx.SRC_TEL]||'').trim();
    const utmS    = String(r[idx.UTM_S]||'').trim();
    const source  = srcTel || utmS;
    const channel = ft_resolveChannel(source);
    const utm = [utmS, String(r[idx.UTM_M]||'').trim(), String(r[idx.UTM_C]||'').trim()].filter(Boolean).join(' / ');
    const deal = { created, status, success, revenue, src: source || 'â€”', channel, utm, name: r[idx.NAME]||'â€”' };
    const obj = byClient.get(key) || {name:client, phone, first:null, deals:[], revenueTotal:0, succAny:false};
    obj.deals.push(deal);
    obj.revenueTotal += revenue;
    if (success) obj.succAny = true;
    const d = created instanceof Date ? created : (created ? new Date(created) : null);
    if (d && (!obj.first || !obj.first.date || d < obj.first.date)) {
      obj.first = { date: d, source: deal.src, channel: channel, utm: utm };
    }
    byClient.set(key, obj);
  });
  return byClient;
}

function ft_aggregateChannelData(byClient) {
  const channels = new Map();
  const details = [];
  for (const c of byClient.values()){
    const chKey = c.first ? (c.first.channel || 'other') : 'other';
    const chTitle = FT_CFG.CHANNEL_TITLE[chKey] || FT_CFG.CHANNEL_TITLE.other;
    const ch = channels.get(chKey) || {title: chTitle, firstCount:0, converted:0, revenue:0};
    ch.firstCount += 1;
    if (c.succAny){
      ch.converted += 1;
      ch.revenue   += c.revenueTotal;
    }
    channels.set(chKey, ch);
    details.push({
      date: c.first?.date || '', client: c.name, phone: c.phone,
      chTitle, source: c.first?.source || 'â€”', utm: c.first?.utm || 'â€”',
      dealsCount: c.deals.length, revenue: c.revenueTotal
    });
  }
  return { channels, details };
}

/* ==================== GPT Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯ ==================== */
function ft_getGptSummary(summaryData, apiKey) {
  try {
    const prompt = ft_buildGptSummaryPrompt(summaryData);
    return ft_callGPT(apiKey, prompt, FT_CFG.GPT_MODEL);
  } catch (e) {
    Logger.log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ GPT Summary: ' + e.toString());
    return 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¾Ñ‚ GPT. ' + e.toString();
  }
}

function ft_buildGptSummaryPrompt(summaryData) {
  const dataText = summaryData.map(c => 
    `- ÐšÐ°Ð½Ð°Ð» "${c.title}": ÐŸÑ€Ð¸Ð²Ñ‘Ð» ${c.firstCount} ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð², ÐºÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ ${ (c.conv * 100).toFixed(1) }%, LTV ${c.ltv.toFixed(0)} â‚½, Ð¾Ð±Ñ‰Ð¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ ${c.revenue.toFixed(0)} â‚½.`
  ).join('\n');
  return `Ð¢Ñ‹ â€” Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€ Ð¿Ð¾ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³Ñƒ. Ð¢ÐµÐ±Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð° ÑÐ²Ð¾Ð´Ð½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ°Ð½Ð°Ð»Ð¾Ð² Ð¿Ð¾ Ð¿ÐµÑ€Ð²Ð¾Ð¼Ñƒ ÐºÐ°ÑÐ°Ð½Ð¸ÑŽ.
ÐÐ°Ð¿Ð¸ÑˆÐ¸ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ (3-5 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹) Executive Summary Ð´Ð»Ñ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ.
Ð’Ñ‹Ð´ÐµÐ»Ð¸ ÑÐ°Ð¼Ñ‹Ð¹ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð» Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ LTV Ð¸ Ð´Ð¾Ñ…Ð¾Ð´) Ð¸ ÑÐ°Ð¼Ñ‹Ð¹ ÑÐ»Ð°Ð±Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð», Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‰Ð¸Ð¹ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ. Ð”Ð°Ð¹ Ð¾Ð´Ð½Ñƒ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑŽ.

Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n${dataText}`;
}

function ft_callGPT(apiKey, prompt, model) {
  const url = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: model, temperature: 0.4, max_tokens: 500,
    messages: [ {role:'system', content:'Ð¢Ñ‹ â€” Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€ Ð¿Ð¾ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³Ñƒ. ÐŸÐ¸ÑˆÐ¸ ÐºÑ€Ð°Ñ‚ÐºÐ¾, Ð¿Ð¾ Ð´ÐµÐ»Ñƒ, ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ‡ÐµÑÐºÐ¸.'}, {role:'user', content: prompt} ]
  };
  const resp = UrlFetchApp.fetch(url, {
    method:'post', contentType:'application/json', payload: JSON.stringify(payload),
    headers: { Authorization: `Bearer ${apiKey}` }, muteHttpExceptions:true
  });
  if (resp.getResponseCode()>=300){ throw new Error('OpenAI ÐžÑˆÐ¸Ð±ÐºÐ° '+resp.getResponseCode()+': '+resp.getContentText()); }
  const data = JSON.parse(resp.getContentText());
  return data?.choices?.[0]?.message?.content?.trim() || 'â€”';
}

/* ==================== Ð“Ð ÐÐ¤Ð˜ÐšÐ˜ Ð˜ ÐžÐ¤ÐžÐ ÐœÐ›Ð•ÐÐ˜Ð• ==================== */
function ft_buildDashboard(sheet, startRow, data) {
  const chartData = [['ÐšÐ°Ð½Ð°Ð»', 'Ð”Ð¾Ñ…Ð¾Ð´', 'LTV', 'ÐŸÐµÑ€Ð²Ñ‹Ñ… ÐºÐ°ÑÐ°Ð½Ð¸Ð¹']];
  data.forEach(x => chartData.push([x.title, x.revenue, x.ltv, x.firstCount]));
  
  const sourceRange = sheet.getRange(startRow, 1, chartData.length, chartData[0].length);
  sourceRange.setValues(chartData);

  const rangeCh = sourceRange.offset(0,0,data.length+1,1), rangeRev = sourceRange.offset(0,1,data.length+1,1),
        rangeLtv = sourceRange.offset(0,2,data.length+1,1), rangeCount = sourceRange.offset(0,3,data.length+1,1);

  const barChartRev = sheet.newChart().asBarChart()
    .addRange(rangeRev).addRange(rangeCh).setMergeStrategy(Charts.ChartMergeStrategy.MERGE_COLUMNS)
    .setOption('title', 'ÐžÐ±Ñ‰Ð¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ Ð¿Ð¾ Ð¿ÐµÑ€Ð²Ð¾Ð¼Ñƒ ÐºÐ°ÑÐ°Ð½Ð¸ÑŽ').setOption('colors', [FT_CFG.COLORS.PRIMARY])
    .setPosition(startRow, 1, 0, 0).build();

  const barChartLtv = sheet.newChart().asBarChart()
    .addRange(rangeLtv).addRange(rangeCh).setMergeStrategy(Charts.ChartMergeStrategy.MERGE_COLUMNS)
    .setOption('title', 'LTV Ð¿Ð¾ Ð¿ÐµÑ€Ð²Ð¾Ð¼Ñƒ ÐºÐ°ÑÐ°Ð½Ð¸ÑŽ').setOption('colors', [FT_CFG.COLORS.SECONDARY])
    .setPosition(startRow, 6, 0, 0).build();

  const pieChart = sheet.newChart().asPieChart()
    .addRange(rangeCount).addRange(rangeCh).setMergeStrategy(Charts.ChartMergeStrategy.MERGE_COLUMNS)
    .setOption('title', 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿ÐµÑ€Ð²Ñ‹Ñ… ÐºÐ°ÑÐ°Ð½Ð¸Ð¹').setOption('is3D', true)
    .setOption('colors', FT_CFG.COLORS.CHART_PALETTE)
    .setPosition(startRow, 11, 0, 0).build();

  sheet.insertChart(barChartRev);
  sheet.insertChart(barChartLtv);
  sheet.insertChart(pieChart);
  sheet.hideRows(startRow, chartData.length);
}

function ft_applyConditionalFormatting(range) {
  const sheet = range.getSheet();
  const rules = sheet.getConditionalFormatRules();
  const newRules = rules.filter(rule => rule.getRanges().every(r => r.getA1Notation() !== range.getA1Notation()));
  
  newRules.push(SpreadsheetApp.newConditionalFormatRule().whenTextContains('âš ï¸ Ð¡Ð»Ð°Ð±Ñ‹Ð¹').setBackground('#FCE8E6').setBold(true).setRanges([range]).build());
  newRules.push(SpreadsheetApp.newConditionalFormatRule().whenTextContains('ðŸŸ¡ Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹').setBackground('#FFF4C2').setRanges([range]).build());
  newRules.push(SpreadsheetApp.newConditionalFormatRule().whenTextContains('ðŸŸ¢ Ð¡Ð¸Ð»ÑŒÐ½Ñ‹Ð¹').setBackground('#CEEAD6').setBold(true).setRanges([range]).build());
  sheet.setConditionalFormatRules(newRules);
}

function ft_formatSheet(sh) {
  sh.setColumnWidth(1, 100); sh.setColumnWidth(2, 180); sh.setColumnWidth(3, 120);
  sh.setColumnWidth(4, 100); sh.setColumnWidth(5, 120); sh.setColumnWidth(6, 180);
  sh.setColumnWidth(7, 100); sh.setColumnWidth(8, 120);
}

/* ==================== Ð£Ð¢Ð˜Ð›Ð˜Ð¢Ð« ==================== */
function ft_readTable(sh) {
  const vals = sh.getDataRange().getValues();
  const headerRow = (vals[1] && vals[1].some(v=>String(v).trim()!=='')) ? 1 : 0;
  return {header: (vals[headerRow]||[]).map(String), rows: vals.slice(headerRow+1).filter(r=>r.some(x=>String(x).trim()!==''))};
}
function ft_getIdx(header){
  const find = (names, rightmost=false)=>{
    const norm = header.map(h=>String(h||'').trim().toLowerCase());
    const keys = Array.isArray(names)?names:[names]; let res = -1;
    norm.forEach((h,i)=>{ keys.forEach(n=>{ const k = String(n).toLowerCase();
    if (h===k || h.includes(k)){ if (rightmost){ if (i>res) res=i; } else if (res===-1) res=i; } }); }); return res;
  };
  const H = FT_CFG.H;
  return { ID: find(H.ID), NAME: find(H.NAME), MANAGER: find(H.MANAGER), STATUS: find(H.STATUS), BUDGET: find(H.BUDGET),
    CREATED: find(H.CREATED), CLIENT: find(H.CLIENT), PHONE: find(H.PHONE), SRC_TEL: find(H.SRC_TEL),
    UTM_S: find(H.UTM_S), UTM_M: find(H.UTM_M), UTM_C: find(H.UTM_C), SUM_RUB: find(H.SUM_RUB, true) };
}
function ft_resolveChannel(source){
  const s = String(source||'').trim().toLowerCase();
  if (!s) return 'other'; const test = (reArr)=>reArr.some(re=>re.test(s));
  const MAP = FT_CFG.MAP;
  if (test(MAP.site)) return 'site'; if (test(MAP.yandex)) return 'yandex'; if (test(MAP.gis2)) return 'gis2';
  if (test(MAP.telegram)) return 'telegram'; if (test(MAP.vk)) return 'vk'; return 'other';
}
function ft_money(v){ if (v==null || v==='') return 0; const n = Number(String(v).replace(/\s+/g,'').replace(',','.')); return isNaN(n)?0:n; }
function ft_toDate(v){ return (v instanceof Date) ? v : (v? new Date(v) : null); }
function ft_cleanPhone(s){ const d = String(s||'').replace(/\D/g,''); if (!d) return '';
  if (d.length===11 && /^[78]/.test(d)) return d.slice(1); if (d.length>=10) return d.slice(-10); return d;
}
function ft_pct(a,b){ return b ? (a/b) : 0; }
function ft_effGrade(conv, ltv){
  if (conv>=0.30 && ltv>=3000) return 'ðŸŸ¢ Ð¡Ð¸Ð»ÑŒÐ½Ñ‹Ð¹';
  if (conv>=0.15 && ltv>=1500) return 'ðŸŸ¡ Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹';
  return 'âš ï¸ Ð¡Ð»Ð°Ð±Ñ‹Ð¹';
}
function ft_setFont(sh, font){ sh.getRange(1,1,Math.max(1,sh.getMaxRows()),Math.max(1,sh.getMaxColumns())).setFontFamily(font); }
function ft_band(sh, row, col, rows, cols, bg){ ensureSize_(sh, row+rows-1, col+cols-1); sh.getRange(row,col,rows,cols).setBackground(bg); }
function ft_title(sh, row, col, text, width, bg){ ensureSize_(sh, row, col+width-1);
  const rng = sh.getRange(row,col,1,width); try{ rng.merge(); }catch(e){}
  rng.setValue(text).setFontWeight('bold').setFontSize(12).setBackground(bg).setFontColor('#fff').setVerticalAlignment('middle');
}
function ft_writeTable(sh, row, col, header, data){
  ensureSize_(sh, row + Math.max(1,data.length), col + header.length - 1);
  const head = sh.getRange(row, col, 1, header.length);
  head.setValues([header]).setFontWeight('bold').setBackground('#E9F2FB').setBorder(true,true,true,true,true,true);
  if (data.length){
    const body = sh.getRange(row+1, col, data.length, header.length);
    body.setValues(data.map(r=>r.map(v=> (v===null||v===undefined)?'':v ))).setBorder(true,true,true,true,true,true);
    const bgs = []; for (let i=0;i<data.length;i++){ const color = (i%2===0)?'#FFFFFF':'#F8FCFF'; bgs.push(Array(header.length).fill(color)); }
    body.setBackgrounds(bgs);
  } else { sh.getRange(row+1, col, 1, header.length).setBorder(true,true,true,true,true,true); }
}
function ensureSize_(sh, needRow, needCol){
  if (sh.getMaxRows() < needRow) sh.insertRowsAfter(sh.getMaxRows(), needRow - sh.getMaxRows());
  if (sh.getMaxColumns() < needCol) sh.insertColumnsAfter(sh.getMaxColumns(), needCol - sh.getMaxColumns());
}

/* ==================== ÐœÐ•ÐÐ® Ð˜ Ð¢Ð Ð˜Ð“Ð“Ð•Ð Ð« ==================== */
function onOpen(){
  SpreadsheetApp.getUi()
    .createMenu('First-Touch')
    .addItem('ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚', 'buildFirstTouchReport')
    .addItem('Hourly Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€', 'ft_setHourlyTrigger')
    .addToUi();
}
function ft_setHourlyTrigger(){
  ScriptApp.getProjectTriggers()
    .filter(t=>t.getHandlerFunction()==='buildFirstTouchReport')
    .forEach(t=>Script.deleteTrigger(t));
  ScriptApp.newTrigger('buildFirstTouchReport').timeBased().everyHours(1).create();
}
