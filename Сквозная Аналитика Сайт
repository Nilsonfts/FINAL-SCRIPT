/************************************************************
 * –°–ê–ô–¢ + –°–ö–í–û–ó–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê (–≤–µ—Ä—Å–∏—è A –∏ B) ‚Äî –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ CFG
 ************************************************************/
const SA_CFG = {
  FONT: 'PT Sans',
  SHEETS: {
    SITE: '–ó–∞—è–≤–∫–∏ —Å –°–∞–π—Ç–∞',
    AMO:  '–†–ê–ë–û–ß–ò–ô –ê–ú–û',
    DASH_SITE: '–°–ê–ô–¢: –ê–ù–ê–õ–ò–¢–ò–ö–ê2',
    DASH_CROSS: '–°–ö–í–û–ó–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê (Site ‚Üí AMO2)'
  },
  SUCCESS_RE: /(–æ–ø–ª–∞—á|—É—Å–ø–µ—à.*–≤\s*—Ä–ø|—É—Å–ø–µ—à.*—Ä–µ–∞–ª–∏–∑)/i,
  SOURCE_ALIASES: [
    {re:/ya_map#booking|yandex_maps|yandex\s*maps|yandex_map/i, to:'ya_map'},
    {re:/2gis/i, to:'2gis'},
    {re:/vk|vkontakte/i, to:'vk'},
    {re:/google/i, to:'google'},
    {re:/direct|none/i, to:'direct'}
  ],
  SITE_HEADERS: {
    phone:['phone','—Ç–µ–ª–µ—Ñ–æ–Ω'],email:['email','e-mail'],
    utm_source:['utm_source'],utm_medium:['utm_medium'],
    utm_campaign:['utm_campaign','utm_campa ign','utm_campaing'],
    utm_term:['utm_term'],utm_content:['utm_content'],
    referrer:['referrer','referer'],landing:['landing_page','current_page'],
    title:['page_title'],timestamp:['timestamp','sent','submit_date'],
    submit_date:['submit_date'],submit_time:['submit_time','time'],
    day_of_week:['day_of_week'],time_of_day:['time_of_day'],timezone:['timezone'],
    device_type:['device_type'],device_model:['device_model'],
    os:['os'],browser:['browser'],screen:['screen_size'],
    visits:['visits_count'],days_from_1:['days_since_first_visit','days_since_first_vi sit'],
    button_text:['button_text','–∫–Ω–æ–ø–∫–∞'],ym:['ym_client_id','ym_client_i d'],
    ga:['ga_client_id','ga_client_i d'],
    first_source:['first_source'],first_ref:['first_referrer'],
    current_source:['current_source'],scroll:['scroll_depth']
  },
  AMO_HEADERS: {
    status:['—Å—Ç–∞—Ç—É—Å','—Å–¥–µ–ª–∫–∞.—Å—Ç–∞—Ç—É—Å'],
    budget:['–±—é–¥–∂–µ—Ç','—Å–¥–µ–ª–∫–∞.–±—é–¥–∂–µ—Ç'],
    ym:['ym_client_id','—Å–¥–µ–ª–∫–∞.ym_client_id','—Å–¥–µ–ª–∫–∞.ym_client id','—Å–¥–µ–ª–∫–∞.y m_client_id'],
    ga:['ga_client_id','—Å–¥–µ–ª–∫–∞.ga_client_id'],
    phone:['—Ç–µ–ª–µ—Ñ–æ–Ω','–∫–æ–Ω—Ç–∞–∫—Ç.—Ç–µ–ª–µ—Ñ–æ–Ω','phone'],
    created:['–¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è','—Å–¥–µ–ª–∫–∞.–¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è']
  }
};

/* ======================== –í–ï–†–°–ò–Ø A ======================== */
// –°–∞–π—Ç: KPI, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∫–∞–º–ø–∞–Ω–∏–∏, –ø–æ—Å–∞–¥–æ—á–Ω—ã–µ, –∫–Ω–æ–ø–∫–∏, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞
function buildSiteAnalytics(){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const site = ss.getSheetByName(SA_CFG.SHEETS.SITE);
  if (!site) throw new Error('–ù–µ—Ç –ª–∏—Å—Ç–∞: ' + SA_CFG.SHEETS.SITE);

  const {header, rows} = readSheet_(site);
  if (!rows.length) return;

  const id = idxFromNames_(header, SA_CFG.SITE_HEADERS);

  const stat = {events:0, uniqueLeads:new Set(), sumVisits:0, sumScroll:0, emptyUtm:0};
  const agg = {
    src:new Map(), cmp:new Map(), land:new Map(), btn:new Map(),
    devType:new Map(), os:new Map(), br:new Map(), wh:new Map(), heat:new Map()
  };

  rows.forEach(r=>{
    stat.events++;
    const phone = cleanDigits_(pick(r,id.phone));
    const email = (pick(r,id.email)||'').toString().trim().toLowerCase();
    if (phone) stat.uniqueLeads.add('p:'+phone); else if (email) stat.uniqueLeads.add('e:'+email);

    const visits = toNum_(pick(r,id.visits))||0; stat.sumVisits += visits;
    let scroll = toNum_(String(pick(r,id.scroll)||'').replace('%','')); if(!isFinite(scroll)) scroll=0; stat.sumScroll+=scroll;

    let src = norm_(pick(r,id.utm_source));
    let med = norm_(pick(r,id.utm_medium));
    let cmp = norm_(pick(r,id.utm_campaign));
    [src,med] = normalizeSrcMed_(src,med);
    cmp = aliasSourceOnly_(cmp);
    if (!src) stat.emptyUtm++;

    const srcKey = `${src} | ${med||'-'}`;
    bump_(agg.src, srcKey, v=>{ v.scroll+=scroll; v.visits+=(visits||0); });

    const cmpKey = `${src||'(none)'} | ${cmp||'(n/a)'}`;
    bump_(agg.cmp, cmpKey);

    const landing = String(pick(r,id.landing)||pick(r,id.title)||'(no title)');
    bump_(agg.land, landing);

    const btn = String(pick(r,id.button_text)||'').trim() || '(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)';
    bump_(agg.btn, btn);

    const dt = normalizeDeviceType_(pick(r,id.device_type), pick(r,id.screen));
    bump_(agg.devType, dt);
    const os = normalizeOS_(pick(r,id.os)); bump_(agg.os, os);
    bump_(agg.br, String(pick(r,id.browser)||'(unknown)'));
    bump_(agg.wh, String(pick(r,id.screen)||'(unknown)'));

    const day = normalizeWeekday_(pick(r,id.day_of_week), pick(r,id.submit_date)||pick(r,id.timestamp));
    const tod = normalizeTimeOfDay_(pick(r,id.time_of_day), pick(r,id.submit_time));
    bump_(agg.heat, `${day}|${tod}`);
  });

  const total = Math.max(1, stat.events);
  const uniq = stat.uniqueLeads.size;
  const avgVisits = stat.sumVisits/total;
  const avgScroll = stat.sumScroll/total;
  const emptyUtmPct = stat.emptyUtm/total;

  const topSrc  = mapToRows_(agg.src, (k,v)=>[k, v.n, round1_(v.scroll/v.n)+' %', round2_(v.visits/v.n)],
                    ['–ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–∞–Ω–∞–ª','–ó–∞—è–≤–∫–∏','–°—Ä. —Å–∫—Ä–æ–ª–ª','–°—Ä. –≤–∏–∑–∏—Ç–æ–≤']);
  const topCmp  = mapToRows_(agg.cmp, (k,v)=>[k, v.n], ['–ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–∞–º–ø–∞–Ω–∏—è','–ó–∞—è–≤–∫–∏']);
  const topLand = mapToRows_(agg.land,(k,v)=>[k, v.n], ['–ü–æ—Å–∞–¥–æ—á–Ω–∞—è / Title','–ó–∞—è–≤–∫–∏']);
  const topBtn  = mapToRows_(agg.btn, (k,v)=>[k, v.n], ['–ö–Ω–æ–ø–∫–∞ / button_text','–ö–ª–∏–∫–∏']);
  const devType = mapToRows_(agg.devType,(k,v)=>[k, v.n, roundP_(v.n/total)], ['–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞','–ó–∞—è–≤–∫–∏','–î–æ–ª—è']);
  const devOS   = mapToRows_(agg.os,(k,v)=>[k, v.n, roundP_(v.n/total)], ['OS','–ó–∞—è–≤–∫–∏','–î–æ–ª—è']);
  const devBr   = mapToRows_(agg.br,(k,v)=>[k, v.n], ['–ë—Ä–∞—É–∑–µ—Ä','–ó–∞—è–≤–∫–∏']);
  const devWh   = mapToRows_(agg.wh,(k,v)=>[k, v.n], ['–≠–∫—Ä–∞–Ω (WxH)','–ó–∞—è–≤–∫–∏']);
  const heat    = heatTable_(agg.heat);

  const sh = ensureSheet_(ss, SA_CFG.SHEETS.DASH_SITE);
  sh.clear(); setFontAll_(sh, SA_CFG.FONT);
  let r=1,c=1;

  drawBand_(sh,r,c,1,14,'#153E5C');
  sh.getRange(r,c,1,14).merge().setValue('üìä –°–ê–ô–¢: –ê–ù–ê–õ–ò–¢–ò–ö–ê')
    .setFontColor('#fff').setFontWeight('bold').setFontSize(18); r++;
  sh.getRange(r,c).setValue('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:').setFontWeight('bold');
  sh.getRange(r,c+1).setValue(new Date()).setNumberFormat('dd.MM.yyyy HH:mm:ss'); r+=2;

  section_(sh,r,c,'‚úÖ –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏',12,'#D8EAC6'); r++;
  writeTable_(sh,r,c,['–ú–µ—Ç—Ä–∏–∫–∞','–ó–Ω–∞—á–µ–Ω–∏–µ','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'],[
    ['–°–æ–±—ã—Ç–∏–π (–æ—Ç–ø—Ä–∞–≤–æ–∫ —Ñ–æ—Ä–º)', stat.events, '–í—Å–µ —Å—Ç—Ä–æ–∫–∏ –ª–∏—Å—Ç–∞ —Å–∞–π—Ç–∞'],
    ['–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–¥—ã', uniq, '–¢–µ–ª–µ—Ñ–æ–Ω/Email (–æ—Ü–µ–Ω–∫–∞)'],
    ['–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª-–≤–æ –≤–∏–∑–∏—Ç–æ–≤ –¥–æ –∑–∞—è–≤–∫–∏', round2_(avgVisits), 'visits_count'],
    ['–°—Ä–µ–¥–Ω—è—è –≥–ª—É–±–∏–Ω–∞ —Å–∫—Ä–æ–ª–ª–∞', round1_(avgScroll)+' %', 'scroll_depth'],
    ['–ë–µ–∑ UTM –∏—Å—Ç–æ—á–Ω–∏–∫–∞', roundP_(emptyUtmPct), 'utm_source –ø—É—Å—Ç']
  ]);
  r+=8;

  section_(sh,r,c,'üìà –¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (source | medium)',14,'#EAF2FF'); r++;
  writeTable_(sh,r,c, topSrc.header, topSrc.rows);
  chartColumn_(sh, r, c, topSrc.rows.length+1, 2, '–ó–∞—è–≤–∫–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º', r+1, 8);
  r += topSrc.rows.length + 3;

  section_(sh,r,c,'üéØ –¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π (source | campaign)',12,'#EEF5FF'); r++;
  writeTable_(sh,r,c, topCmp.header, topCmp.rows);
  r += topCmp.rows.length + 2;

  section_(sh,r,c,'üåê –ü–æ—Å–∞–¥–æ—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã',12,'#EAF7E8'); r++;
  writeTable_(sh,r,c, topLand.header, topLand.rows);
  chartColumn_(sh, r, c, topLand.rows.length+1, 2, '–ó–∞—è–≤–∫–∏ –ø–æ –ø–æ—Å–∞–¥–æ—á–Ω—ã–º', r+1, 8);
  r += topLand.rows.length + 3;

  section_(sh,r,c,'üîò –ö–Ω–æ–ø–∫–∏ (button_text)',8,'#FFF6E1'); r++;
  writeTable_(sh,r,c, topBtn.header, topBtn.rows);
  r += topBtn.rows.length + 2;

  section_(sh,r,c,'üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',8,'#F3F3F3'); r++;
  writeTable_(sh,r,c, devType.header, devType.rows); r += devType.rows.length + 1;
  writeTable_(sh,r,c, devOS.header, devOS.rows);     r += devOS.rows.length + 1;
  writeTable_(sh,r,c, devBr.header, devBr.rows);     r += devBr.rows.length + 1;
  writeTable_(sh,r,c, devWh.header, devWh.rows);     r += devWh.rows.length + 2;

  section_(sh,r,c,'üïí –í—Ä–µ–º—è (–¥–Ω–∏ √ó –≤—Ä–µ–º—è —Å—É—Ç–æ–∫)',10,'#FFE7CC'); r++;
  writeTable_(sh,r,c, heat.header, heat.rows);
  r += heat.rows.length + 2;

  autoResizeAll_(sh);
}
function setHourlyTrigger_Site(){
  resetTrigger_('buildSiteAnalytics');
  ScriptApp.newTrigger('buildSiteAnalytics').timeBased().everyHours(1).create();
}

/* ======================== –í–ï–†–°–ò–Ø B ======================== */
// –°–ö–í–û–ó–ù–ê–Ø: join Site ‚Üí AMO (–º–∞—Ç—á –ø–æ ym ‚Üí ga ‚Üí —Ç–µ–ª–µ—Ñ–æ–Ω), –î–æ—Ö–æ–¥ –ø–æ —É—Å–ø–µ—à–Ω—ã–º
function buildSiteToAmoAnalytics(){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const siteSh = ss.getSheetByName(SA_CFG.SHEETS.SITE);
  const amoSh  = ss.getSheetByName(SA_CFG.SHEETS.AMO);
  if (!siteSh) throw new Error('–ù–µ—Ç –ª–∏—Å—Ç–∞: '+SA_CFG.SHEETS.SITE);
  if (!amoSh)  throw new Error('–ù–µ—Ç –ª–∏—Å—Ç–∞: '+SA_CFG.SHEETS.AMO);

  const site = readSheet_(siteSh);
  const amo  = readSheet_(amoSh);

  const si = idxFromNames_(site.header, SA_CFG.SITE_HEADERS);
  const ai = idxFromNames_(amo.header,  SA_CFG.AMO_HEADERS);

  let iAX=-1; amo.header.forEach((h,i)=>{ if (String(h).toLowerCase().includes('—Å—É–º–º–∞') && String(h).includes('‚ÇΩ')) iAX=i; });

  const IDX = {ym:new Map(), ga:new Map(), ph:new Map()};
  amo.rows.forEach((r,idx)=>{
    const ym=cleanDigits_(pick(r,ai.ym)); if(ym) IDX.ym.set(ym,idx);
    const ga=cleanDigits_(pick(r,ai.ga)); if(ga) IDX.ga.set(ga,idx);
    const ph=cleanDigits_(pick(r,ai.phone)); if(ph) IDX.ph.set(ph,idx);
  });

  const agg = { src:new Map(), cmp:new Map(), land:new Map() };
  function applyDeal(arow, b){
    const st = normalizeStatus_(pick(arow, ai.status));
    const ok = SA_CFG.SUCCESS_RE.test(st);
    const ax = toMoney_(arow[iAX]);
    const budget = toMoney_(pick(arow, ai.budget));
    const rev = ok ? (ax>0?ax:budget) : 0;
    b.deals++; if(ok){ b.succ++; b.rev+=rev; }
  }
  function bkt(m,k){ const v=m.get(k)||{deals:0,succ:0,rev:0}; m.set(k,v); return v; }

  site.rows.forEach(r=>{
    let src=norm_(pick(r,si.utm_source)), med=norm_(pick(r,si.utm_medium)), cmp=norm_(pick(r,si.utm_campaign));
    [src,med]=normalizeSrcMed_(src,med); cmp=aliasSourceOnly_(cmp);
    const srcKey=`${src} | ${med||'-'}`, cmpKey=`${src||'(none)'} | ${cmp||'(n/a)'}`;
    const land=String(pick(r,si.landing)||pick(r,si.title)||'(no title)');

    const ym=cleanDigits_(pick(r,si.ym)), ga=cleanDigits_(pick(r,si.ga)), ph=cleanDigits_(pick(r,si.phone));
    let aiRow=-1; if(ym&&IDX.ym.has(ym)) aiRow=IDX.ym.get(ym); else if(ga&&IDX.ga.has(ga)) aiRow=IDX.ga.get(ga); else if(ph&&IDX.ph.has(ph)) aiRow=IDX.ph.get(ph);

    const buckets=[bkt(agg.src,srcKey), bkt(agg.cmp,cmpKey), bkt(agg.land,land)];
    if (aiRow>=0) buckets.forEach(b=>applyDeal(amo.rows[aiRow],b)); else buckets.forEach(b=>b.deals++);
  });

  function finalize(map, title){
    const arr=[...map.entries()].map(([k,v])=>{
      const conv=v.deals? v.succ/v.deals:0, avg=v.succ? v.rev/v.succ:0;
      return [k,v.deals,v.succ,v.rev,avg,conv];
    }).sort((a,b)=>b[3]-a[3]);
    return {header:[title,'–°–¥–µ–ª–∫–∏','–£—Å–ø–µ—à–Ω—ã–µ','–î–æ—Ö–æ–¥ ‚ÇΩ','–°—Ä. —á–µ–∫ ‚ÇΩ','–ö–æ–Ω–≤–µ—Ä—Å–∏—è'], rows:arr};
  }
  const tSrc=finalize(agg.src,'–ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–∞–Ω–∞–ª');
  const tCmp=finalize(agg.cmp,'–ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–∞–º–ø–∞–Ω–∏—è');
  const tLand=finalize(agg.land,'–ü–æ—Å–∞–¥–æ—á–Ω–∞—è / Title');

  const sh = ensureSheet_(ss, SA_CFG.SHEETS.DASH_CROSS);
  sh.clear(); setFontAll_(sh, SA_CFG.FONT);
  let r=1,c=1;

  drawBand_(sh,r,c,1,14,'#2C3E50');
  sh.getRange(r,c,1,14).merge().setValue('üîó –°–ö–í–û–ó–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê (Site ‚Üí AMO)')
    .setFontColor('#fff').setFontWeight('bold').setFontSize(18); r++;
  sh.getRange(r,c).setValue('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:').setFontWeight('bold');
  sh.getRange(r,c+1).setValue(new Date()).setNumberFormat('dd.MM.yyyy HH:mm:ss'); r+=2;

  section_(sh,r,c,'üìà –ò—Å—Ç–æ—á–Ω–∏–∫–∏',14,'#EAF2FF'); r++;
  writeTable_(sh,r,c, tSrc.header, tSrc.rows);
  chartColumn_(sh, r, c, Math.max(1,tSrc.rows.length+1), 4, '–î–æ—Ö–æ–¥ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º', r+1, 8);
  r += tSrc.rows.length + 3;

  section_(sh,r,c,'üéØ –ö–∞–º–ø–∞–Ω–∏–∏',12,'#EEF5FF'); r++;
  writeTable_(sh,r,c, tCmp.header, tCmp.rows);
  r += tCmp.rows.length + 2;

  section_(sh,r,c,'üåê –ü–æ—Å–∞–¥–æ—á–Ω—ã–µ',12,'#EAF7E8'); r++;
  writeTable_(sh,r,c, tLand.header, tLand.rows);
  r += tLand.rows.length + 2;

  autoResizeAll_(sh);
}
function setHourlyTrigger_Cross(){
  resetTrigger_('buildSiteToAmoAnalytics');
  ScriptApp.newTrigger('buildSiteToAmoAnalytics').timeBased().everyHours(1).create();
}

/* ====================== –•–ï–õ–ü–ï–†–´ ===================== */
function readSheet_(sh){ const v=sh.getDataRange().getValues(); return {header:(v[0]||[]).map(String), rows:v.slice(1).filter(r=>r.some(x=>String(x).trim()!==''))}; }
function idxFromNames_(header, dict){ const norm=header.map(h=>norm_(h)); const out={}; Object.keys(dict).forEach(k=>{ let idx=-1; for (const nm of dict[k]){ const n=norm_(nm); idx=norm.indexOf(n); if(idx<0) idx=norm.findIndex(h=>h===n||h.includes(n)); if(idx>-1) break; } out[k]=idx; }); return out; }
function pick(r,i){ return (i>=0? r[i]:''); }
function norm_(s){ return String(s||'').trim().toLowerCase(); }
function toNum_(v){ const n=Number(String(v||'').replace(/\s/g,'').replace(',','.')); return isNaN(n)?0:n; }
function toMoney_(v){ return Math.max(0,toNum_(v)); }
function round1_(x){ return Math.round(x*10)/10; }
function round2_(x){ return Math.round(x*100)/100; }
function roundP_(x){ return (Math.round((x||0)*10000)/100)+'%'; }
function cleanDigits_(s){ return String(s||'').replace(/\D/g,''); }
function aliasSourceOnly_(s){ let y=s||''; SA_CFG.SOURCE_ALIASES.forEach(a=>{ if(a.re.test(y)) y=a.to; }); return y; }
function normalizeSrcMed_(src,med){ src=aliasSourceOnly_(src||''); med=(med||'').trim().toLowerCase(); if(!src) src='direct'; return [src,med]; }
function normalizeDeviceType_(dt, screen){ let d=norm_(dt); if(!d||d==='unknown'){ const w=parseInt(String(screen||'').split('x')[0],10); if(isFinite(w)){ if(w<=480)d='mobile'; else if(w<=1024)d='tablet'; else d='desktop'; } else d='unknown'; } if(/phone|mobile/i.test(dt)) d='mobile'; if(/tablet/i.test(dt)) d='tablet'; if(/pc|desktop/i.test(dt)) d='desktop'; return d||'unknown'; }
function normalizeOS_(os){ const s=norm_(os); if(/ios|iphone|ipad|mac\s?os/i.test(os)) return 'iOS/macOS'; if(/android/i.test(os)) return 'Android'; if(/windows/i.test(os)) return 'Windows'; if(/linux/i.test(os)) return 'Linux'; if(!s) return '(unknown)'; return os; }
function normalizeWeekday_(dow, dateLike){ const v=String(dow||'').toLowerCase(); if(v) return ruDow_(v); const d=dateLikeToDate_(dateLike); return ruDowIdx_(d.getDay()); }
function normalizeTimeOfDay_(tod, timeLike){ const v=String(tod||'').toLowerCase(); if(v) return ruTod_(v); const t=String(timeLike||'').trim(); const m=t.match(/(\d{1,2})\s*:\s*\d{2}/); const h=m?Number(m[1]):0; if(h>=5&&h<11) return '—É—Ç—Ä–æ'; if(h>=11&&h<17) return '–¥–µ–Ω—å'; if(h>=17&&h<23) return '–≤–µ—á–µ—Ä'; return '–Ω–æ—á—å'; }
function ruDow_(v){ const map={'mon':'–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','tue':'–≤—Ç–æ—Ä–Ω–∏–∫','wed':'—Å—Ä–µ–¥–∞','thu':'—á–µ—Ç–≤–µ—Ä–≥','fri':'–ø—è—Ç–Ω–∏—Ü–∞','sat':'—Å—É–±–±–æ—Ç–∞','sun':'–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'}; if(map[v])return map[v]; if(/–ø–æ–Ω|mon/.test(v))return'–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫'; if(/–≤—Ç–æ—Ä|tue/.test(v))return'–≤—Ç–æ—Ä–Ω–∏–∫'; if(/—Å—Ä–µ–¥|wed/.test(v))return'—Å—Ä–µ–¥–∞'; if(/—á–µ—Ç–≤|thu/.test(v))return'—á–µ—Ç–≤–µ—Ä–≥'; if(/–ø—è—Ç|fri/.test(v))return'–ø—è—Ç–Ω–∏—Ü–∞'; if(/—Å—É–±|sat/.test(v))return'—Å—É–±–±–æ—Ç–∞'; if(/–≤–æ—Å–∫|sun/.test(v))return'–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'; return v||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; }
function ruDowIdx_(i){ const arr=['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞']; return arr[i]||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; }
function ruTod_(v){ if(/—É—Ç—Ä–æ/.test(v))return'—É—Ç—Ä–æ'; if(/–¥–µ–Ω—å/.test(v))return'–¥–µ–Ω—å'; if(/–≤–µ—á/.test(v))return'–≤–µ—á–µ—Ä'; if(/–Ω–æ—á/.test(v))return'–Ω–æ—á—å'; return v||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; }
function dateLikeToDate_(v){ if(v instanceof Date) return v; const s=String(v||'').trim(); const t=Date.parse(s.replace(/(\d{2}).(\d{2}).(\d{4})/,'$3-$2-$1')); return isNaN(t)? new Date(): new Date(t); }
function bump_(map,key,extra){ const v=map.get(key)||{n:0, first:0, visits:0, scroll:0, deals:0, succ:0, rev:0}; v.n++; if(typeof extra==='function') extra(v); map.set(key,v); }
function mapToRows_(map,fn,header){ const rows=[...map.entries()].map(([k,v])=>fn(k,v)).sort((a,b)=> (b[1]||0)-(a[1]||0)); return {header,rows}; }
function heatTable_(heat){ const days=['–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞','–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ']; const tods=['—É—Ç—Ä–æ','–¥–µ–Ω—å','–≤–µ—á–µ—Ä','–Ω–æ—á—å']; const rows=[]; days.forEach(d=>{ const line=[d]; tods.forEach(t=> line.push( (heat.get(d+'|'+t)?.n)||0 )); rows.push(line); }); return {header:['–î–µ–Ω—å','–£—Ç—Ä–æ','–î–µ–Ω—å','–í–µ—á–µ—Ä','–ù–æ—á—å'], rows}; }
function ensureSheet_(ss,name){ return ss.getSheetByName(name)||ss.insertSheet(name); }
function setFontAll_(sh,font){ sh.getRange(1,1,sh.getMaxRows(),sh.getMaxColumns()).setFontFamily(font); }
function drawBand_(sh,r,c,rows,cols,bg){ sh.getRange(r,c,rows,cols).setBackground(bg); }
function section_(sh,r,c,title,width,bg){ drawBand_(sh,r,c,1,width,bg||'#eee'); const rg=sh.getRange(r,c,1,width); try{rg.merge();}catch(e){} rg.setValue(title).setFontWeight('bold').setFontSize(14).setBorder(null,null,true,null,false,false,'#4A90E2',SpreadsheetApp.BorderStyle.SOLID); }
function writeTable_(sh,r,c,header,rows){ const w=header.length; sh.getRange(r,c,1,w).setValues([header]).setFontWeight('bold').setBackground('#F4F7FB'); if(rows.length) sh.getRange(r+1,c,rows.length,w).setValues(rows); sh.getRange(r,c,Math.max(1,rows.length+1),w).setBorder(true,true,true,true,true,true); }
function chartColumn_(sh,r,c,rows,valCol,title,posR,posC){ try{ const ch=sh.newChart().setChartType(Charts.ChartType.COLUMN).addRange(sh.getRange(r,c,rows,2)).setOption('title',title).setOption('legend.position','none').setOption('useFirstColumnAsDomain',true).setPosition(posR,posC,0,0).build(); sh.insertChart(ch);}catch(e){} }
function autoResizeAll_(sh){ const cols=sh.getLastColumn(); for (let i=1;i<=cols;i++) try{sh.autoResizeColumn(i);}catch(e){} }
function normalizeStatus_(raw){ let s=String(raw||'').trim(); s=s.replace(/^\s*–≤—Å–µ\s*–±–∞—Ä—ã\s*—Å–µ—Ç–∏\s*(?:[\/\\|:\-‚Äì‚Äî]\s*)?/i,'').replace(/\s*(?:-|‚Äì|‚Äî)\s*.*$/,'').trim(); const rules=[[/–æ–ø–ª–∞—á/i,'–û–ø–ª–∞—á–µ–Ω–æ'],[/—É—Å–ø–µ—à.*–≤\s*—Ä–ø/i,'–£—Å–ø–µ—à–Ω–æ –≤ –†–ü'],[/—É—Å–ø–µ—à.*—Ä–µ–∞–ª–∏–∑/i,'–£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ'],[/–∑–∞–∫—Ä—ã—Ç–æ.*–Ω–µ.*—Ä–µ–∞–ª–∏–∑/i,'–ó–∞–∫—Ä—ã—Ç–æ –∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ'],[/–∫–æ–Ω—Ç—Ä–æ–ª.*–æ–ø–ª–∞—Ç/i,'–ö–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–ª–∞—Ç—ã'],[/–ø–µ—Ä–µ–Ω–æ—Å.*–æ—Ç–∫—Ä—ã—Ç–æ–π.*–¥–∞—Ç/i,'–ü–µ—Ä–µ–Ω–æ—Å —Å –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–∞—Ç–æ–π'],[/–≤–æ–ø—Ä–æ—Å.*–±–∞—Ä—É/i,'–í–æ–ø—Ä–æ—Å –∫ –±–∞—Ä—É'],[/–Ω–¥–∑|–Ω–µ\s*–¥–æ–∑–≤–æ–Ω/i,'–ù–î–ó'],[/–∞–≤—Ç–æ.*—Ä–∞—Å–ø—Ä–µ–¥–µ–ª/i,'–ê–≤—Ç–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ'],[/–≤\s*—Ä–∞–±–æ—Ç–µ|–≤–∑—è–ª–∏\s*–≤\s*—Ä–∞–±–æ—Ç—É/i,'–í–∑—è–ª–∏ –≤ —Ä–∞–±–æ—Ç—É']]; for (const [re,n] of rules){ if(re.test(s)) return n; } return s||'–ù–æ–≤—ã–π –ª–∏–¥'; }
function resetTrigger_(fn){ ScriptApp.getProjectTriggers().forEach(t=>{ if(t.getHandlerFunction()===fn) ScriptApp.deleteTrigger(t); }); }
