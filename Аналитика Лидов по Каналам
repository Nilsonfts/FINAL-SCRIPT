/**
 * Â«ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ Ð›Ð˜Ð”ÐžÐ’ ÐŸÐž ÐšÐÐÐÐ›ÐÐœÂ» â€” Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ñ:
 *  â€¢ Ð¾Ð±Ñ‰ÐµÐ¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¾Ð¹,
 *  â€¢ Ñ‚Ð¾Ð¿Ð¾Ð¼ ÐºÐ°Ð½Ð°Ð»Ð¾Ð² Ð¿Ð¾ Ð´Ð¾Ñ…Ð¾Ð´Ñƒ,
 *  â€¢ ÐºÑ€ÑƒÐ³Ð¾Ð²Ð¾Ð¹ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð¾Ð¹ Â«Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð° Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼Â»,
 *  â€¢ Ð¿Ð¾Ð¼ÐµÑÑÑ‡Ð½Ð¾Ð¹ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ¾Ð¹ Ð´Ð¾Ñ…Ð¾Ð´Ð° Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼ (ÑÑ‚Ð¾Ð¿ÐºÐ°/Ð³Ñ€ÑƒÐ¿Ð¿Ð° ÑÑ‚Ð¾Ð»Ð±Ñ†Ð¾Ð²).
 * Ð¨Ñ€Ð¸Ñ„Ñ‚: PT Sans. ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð»Ð¾Ð¼Ð°ÐµÐ¼ Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð»Ð¸ÑÑ‚Ð°Ñ….
 */

const LPC_CFG = {
  SHEET: 'ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ Ð›Ð˜Ð”ÐžÐ’ ÐŸÐž ÐšÐÐÐÐ›ÐÐœ',
  FONT: 'PT Sans'
};

function buildLeadsPerChannelReport(){
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð²Ð·ÑÑ‚ÑŒ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸ Ð¸Ð· Ñ‚Ð²Ð¾ÐµÐ³Ð¾ Marketing Analytics
  let aggr = null;
  try{ if (typeof aggregateForRomi_ === 'function') aggr = aggregateForRomi_(); }catch(e){}
  if (!aggr){ aggr = aggregateFromRA_(); } // fallback: ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð¿Ð¾Ð¼ÐµÑÑÑ‡Ð½Ð¾ ÑÐ°Ð¼Ð¸

  // Ð¡Ð²Ð¾Ð´Ð½Ñ‹Ðµ Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼ (Ð»Ð¸Ð´Ñ‹/Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹/Ð´Ð¾Ñ…Ð¾Ð´/ÑÑ€.Ñ‡ÐµÐº/ÐºÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ)
  const chanRows = (aggr.chanTable||[]).map(r=>({
    channel: String(r[0]||''),
    leads: Number(r[2]||0),
    paid: Number(r[3]||0),
    revenue: Number(r[4]||0),
    avg: (Number(r[3]||0)>0? Number(r[4]||0)/Number(r[3]||0):0),
    conv: (Number(r[2]||0)>0? Number(r[3]||0)/Number(r[2]||0):0)
  }));

  // ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
  const totalLeads = chanRows.reduce((s,x)=>s+x.leads,0);
  const totalPaid  = chanRows.reduce((s,x)=>s+x.paid,0);
  const totalRev   = chanRows.reduce((s,x)=>s+x.revenue,0);
  const avgCheck   = (totalPaid>0? totalRev/totalPaid : 0);
  const convTotal  = (totalLeads>0? totalPaid/totalLeads : 0);

  // Ð¢Ð¾Ð¿ ÐºÐ°Ð½Ð°Ð»Ð¾Ð² Ð¿Ð¾ Ð´Ð¾Ñ…Ð¾Ð´Ñƒ (Ð¾Ñ‚ÑÐ¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ revenue)
  chanRows.sort((a,b)=>b.revenue-a.revenue);

  // --- Ð Ð•ÐÐ”Ð•Ð  ---
  const sh = ss.getSheetByName(LPC_CFG.SHEET) || ss.insertSheet(LPC_CFG.SHEET);
  sh.clear();

  // Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº-Ð±Ð°Ð½Ð½ÐµÑ€
  const banner = sh.getRange(1,1,1,7); try{ banner.merge(); }catch(e){}
  banner.setValue('ðŸ“Š ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ Ð›Ð˜Ð”ÐžÐ’ ÐŸÐž ÐšÐÐÐÐ›ÐÐœ')
        .setFontFamily(LPC_CFG.FONT).setFontWeight('bold').setFontSize(18)
        .setHorizontalAlignment('center').setVerticalAlignment('middle')
        .setBackground('#CFE8FF');
  try{ banner.setBorder(null,null,true,null,false,false,'#4A90E2',SpreadsheetApp.BorderStyle.SOLID);}catch(e){}

  // ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
  sh.getRange(2,1).setValue('â± ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð¸Ðµ:')
    .setFontFamily(LPC_CFG.FONT).setFontWeight('bold');
  sh.getRange(2,2).setValue(new Date()).setNumberFormat('dd.mm.yyyy, HH:mm:ss').setFontFamily(LPC_CFG.FONT);

  // Ð‘Ð»Ð¾Ðº Â«ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°Â» (Ð·ÐµÐ»Ñ‘Ð½Ð°Ñ Ð¿Ð¾Ð»Ð¾ÑÐ°)
  sectionTitle_(sh, 3, 1, 'âœ… ÐžÐ‘Ð©ÐÐ¯ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ', 7, '#E6FFE6', LPC_CFG.FONT);
  const genHead = ['ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒ','Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ'];
  const genData = [
    ['Ð’ÑÐµÐ³Ð¾ Ð»Ð¸Ð´Ð¾Ð²', totalLeads],
    ['Ð›Ð¸Ð´Ð¾Ð² Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð¾Ð¹', totalPaid],
    ['ÐžÐ±Ñ‰Ð¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ â‚½', totalRev],
    ['Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ñ‡ÐµÐº â‚½', avgCheck],
    ['ÐšÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ Ð² Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ', convTotal]
  ];
  sh.getRange(4,1,1,2).setValues([genHead]).setFontWeight('bold').setFontFamily(LPC_CFG.FONT).setBackground('#E6F7FF');
  sh.getRange(5,1,genData.length,2).setValues(genData).setFontFamily(LPC_CFG.FONT);
  sh.getRange(5,2,genData.length,1).setNumberFormat('@');
  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹ Ñ‡Ð¸ÑÐµÐ»
  sh.getRange(5,2,3,1).setNumberFormat('#,##0'); // Ð»Ð¸Ð´Ñ‹/Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹/Ð´Ð¾Ñ…Ð¾Ð´
  sh.getRange(8,2,1,1).setNumberFormat('#,##0.00'); // ÑÑ€ Ñ‡ÐµÐº
  sh.getRange(9,2,1,1).setNumberFormat('0.0%'); // ÐºÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ
  applyTableFrame_(sh.getRange(4,1,1+genData.length,2), LPC_CFG.FONT);

  // Ð‘Ð»Ð¾Ðº Â«Ð¢ÐžÐŸ ÐšÐÐÐÐ›ÐžÐ’ ÐŸÐž Ð”ÐžÐ¥ÐžÐ”Ð£Â» (ÐºÑ€Ð°ÑÐ½Ð°Ñ Ð¿Ð¾Ð»Ð¾ÑÐ°)
  const startTop = 11;
  sectionTitle_(sh, startTop, 1, 'ðŸ† Ð¢ÐžÐŸ ÐšÐÐÐÐ›ÐžÐ’ ÐŸÐž Ð”ÐžÐ¥ÐžÐ”Ð£', 7, '#FFE6E6', LPC_CFG.FONT);
  const headTop = ['ÐšÐ°Ð½Ð°Ð»','Ð›Ð¸Ð´Ð¾Ð²','Ð¡ Ð¾Ð¿Ð»Ð°Ñ‚Ð¾Ð¹','Ð”Ð¾Ñ…Ð¾Ð´ â‚½','Ð¡Ñ€. Ñ‡ÐµÐº â‚½','ÐšÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ','% Ð¾Ñ‚ Ð¾Ð±Ñ‰ÐµÐ³Ð¾'];
  sh.getRange(startTop+1,1,1,headTop.length).setValues([headTop]).setFontFamily(LPC_CFG.FONT).setFontWeight('bold').setBackground('#E6F7FF');
  const rowsTop = chanRows.map(x=>[
    x.channel, x.leads, x.paid, x.revenue, x.avg, x.conv, (totalRev>0? x.revenue/totalRev:0)
  ]);
  const nTop = Math.max(1, rowsTop.length);
  if (rowsTop.length) sh.getRange(startTop+2,1,rowsTop.length,headTop.length).setValues(rowsTop).setFontFamily(LPC_CFG.FONT);
  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹
  sh.getRange(startTop+2,2,nTop,2).setNumberFormat('#,##0'); // Ð»Ð¸Ð´Ñ‹/Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
  sh.getRange(startTop+2,4,nTop,2).setNumberFormat('#,##0'); // Ð´Ð¾Ñ…Ð¾Ð´/ÑÑ€ Ñ‡ÐµÐº
  sh.getRange(startTop+2,6,nTop,2).setNumberFormat('0.0%'); // ÐºÐ¾Ð½Ð²ÐµÑ€ÑÐ¸Ñ/Ð´Ð¾Ð»Ñ
  applyZebra_(sh.getRange(startTop+1,1,nTop+1,headTop.length));
  applyTableFrame_(sh.getRange(startTop+1,1,nTop+1,headTop.length), LPC_CFG.FONT);

  // ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð² (ÑÐ¿Ñ€Ð°Ð²Ð°)
  const chartCol = 9; // I
  const pieData = [['ÐšÐ°Ð½Ð°Ð»','Ð”Ð¾Ñ…Ð¾Ð´ â‚½']].concat(chanRows.map(x=>[x.channel,x.revenue]));
  sh.getRange(3, chartCol, pieData.length, 2).setValues(pieData).setFontFamily(LPC_CFG.FONT);

  // ÐŸÐ¾Ð¼ÐµÑÑÑ‡Ð½Ð°Ñ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ð° Ð´Ð¾Ñ…Ð¾Ð´Ð° Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼
  const monthly = aggregateMonthlyRevenue_(aggr); // {months[], channels[], rows: [[m,ch,rev], ...]}
  const gridHead = ['ÐœÐµÑÑÑ†', ...monthly.channels];
  const grid = monthly.months.map(m=>{
    const line=[monthLabelRu_(m)];
    monthly.channels.forEach(ch=>{ line.push(monthly.value(m,ch)); });
    return line;
  });
  const gridStart = 3 + pieData.length + 2;
  sh.getRange(gridStart, chartCol, 1, gridHead.length).setValues([gridHead]).setFontFamily(LPC_CFG.FONT).setFontWeight('bold').setBackground('#E6F7FF');
  if (grid.length) sh.getRange(gridStart+1, chartCol, grid.length, gridHead.length).setValues(grid).setFontFamily(LPC_CFG.FONT);
  applyZebra_(sh.getRange(gridStart, chartCol, Math.max(1,grid.length+1), gridHead.length));
  applyTableFrame_(sh.getRange(gridStart, chartCol, Math.max(1,grid.length+1), gridHead.length), LPC_CFG.FONT);

  SpreadsheetApp.flush();

  // --- Ð”Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ---
  // Ð£Ð´Ð°Ð»Ð¸Ð¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ
  try{ sh.getCharts().forEach(c=>sh.removeChart(c)); }catch(e){}

  // Pie: Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð° Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼
  const pie = sh.newChart().setChartType(Charts.ChartType.PIE)
    .addRange(sh.getRange(3, chartCol, pieData.length, 2))
    .setOption('title','Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð´Ð¾Ñ…Ð¾Ð´Ð° Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼')
    .setOption('legend.position','right')
    .setOption('pieHole',0)
    .setOption('sliceVisibilityThreshold',0)
    .setOption('titleTextStyle',{fontSize:14,bold:true,fontName:LPC_CFG.FONT})
    .setOption('legend.textStyle',{fontSize:11,fontName:LPC_CFG.FONT})
    .setOption('chartArea',{left:40, top:40, width:'85%', height:'80%'})
    .setPosition(3, 12, 0, 0)
    .build();
  sh.insertChart(pie);

  // Stacked column: Ð´Ð¾Ñ…Ð¾Ð´ Ð¿Ð¾ Ð¼ÐµÑÑÑ†Ð°Ð¼ Ð¸ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼
  if (grid.length && gridHead.length>1){
    const col = sh.newChart().setChartType(Charts.ChartType.COLUMN)
      .addRange(sh.getRange(gridStart, chartCol, grid.length+1, gridHead.length))
      .setOption('isStacked', true)
      .setOption('title','Ð”Ð¾Ñ…Ð¾Ð´ Ð¿Ð¾ Ð¼ÐµÑÑÑ†Ð°Ð¼ Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ð°Ð¼')
      .setOption('legend.position','top')
      .setOption('titleTextStyle',{fontSize:14,bold:true,fontName:LPC_CFG.FONT})
      .setOption('hAxis',{ slantedText:true, slantedTextAngle:20, textStyle:{fontSize:11,fontName:LPC_CFG.FONT}})
      .setOption('vAxis',{ textStyle:{fontSize:11,fontName:LPC_CFG.FONT}})
      .setOption('chartArea',{left:40, top:40, width:'85%', height:'60%'})
      .setPosition(20, 12, 0, 0)
      .build();
    sh.insertChart(col);
  }
}

/** ===== Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸ ===== */
function aggregateFromRA_(){
  // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÑÑ‡Ñ‘Ñ‚, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ aggregateForRomi_()
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ra = (typeof readRA_==='function')? readRA_(ss) : readRA2_(ss);
  const dir = (typeof readDirectory_==='function')? readDirectory_(ss) : readDirectory2_(ss);
  const PAID_RE = /(Ð¾Ð¿Ð»Ð°Ñ‡|ÑƒÑÐ¿ÐµÑˆ|Ñ€ÐµÐ°Ð»Ð¸Ð·)/i;

  const byChan = new Map(); // ch -> {leads, paid, revenue}
  const byMonChan = new Map(); // 'YYYY-MM' -> Map(ch->{revenue})
  const iStatus = ra.idx.status, iSum=ra.idx.sum, iBudget=ra.idx.budget, iCreated=ra.idx.created, iTelTag=ra.idx.telTag;
  const ilines = ra.idx.lines || [];

  ra.rows.forEach(r=>{
    // ÐºÐ°Ð½Ð°Ð»
    let tag='', ch='';
    if (iTelTag>-1) tag = cleanTag_(r[iTelTag]);
    if (!tag && ilines.length){
      for (let k=0;k<ilines.length;k++){
        const num = pickOneNumber_(r[ilines[k]]); if (!num) continue; const rec = dir.byNumber.get(num); if (rec){ tag=rec.tag; ch=rec.channel; break; }
      }
    }
    if (!ch && tag) ch = dir.tag2channel.get(tag) || '';
    ch = normalizeChannel_(ch||'Other');

    // ÑÑ‚Ð°Ñ‚ÑƒÑ/ÑÑƒÐ¼Ð¼Ð°
    const paid = PAID_RE.test(String(iStatus>-1? r[iStatus]:''));
    let amount = toNumber_(iSum>-1 ? r[iSum] : 0);
    if (paid && amount<=0 && iBudget>-1) amount = toNumber_(r[iBudget]);

    // Ð¿Ð¾ ÐºÐ°Ð½Ð°Ð»Ñƒ
    const c = byChan.get(ch) || {leads:0, paid:0, revenue:0};
    c.leads++; if (paid){ c.paid++; if (amount>0) c.revenue += amount; }
    byChan.set(ch, c);

    // Ð¿Ð¾ Ð¼ÐµÑÑÑ†Ñƒ
    const m = monthKey_(iCreated>-1? r[iCreated] : ''); if (m){
      const map = byMonChan.get(m) || new Map();
      const cell = map.get(ch) || {revenue:0};
      if (paid && amount>0) cell.revenue += amount;
      map.set(ch, cell); byMonChan.set(m, map);
    }
  });

  const chanTable=[]; byChan.forEach((v,ch)=>{ const avg=(v.paid? v.revenue/v.paid:0), conv=(v.leads? v.paid/v.leads:0); chanTable.push([ch, '', v.leads, v.paid, v.revenue, avg, conv]); });

  const monthlyFlat=[]; byMonChan.forEach((m,chMap)=>{ chMap.forEach((v,ch)=>{ monthlyFlat.push([m,ch,(byChan.get(ch)||{leads:0}).leads,(byChan.get(ch)||{paid:0}).paid,v.revenue, ( (byChan.get(ch)||{paid:0,revenue:0}).paid ? (byChan.get(ch).revenue/byChan.get(ch).paid) : 0 ), 0]); }); });
  const channelsList=[...byChan.keys()].sort();
  return { chanTable, monthlyFlat, channelsList };
}

function aggregateMonthlyRevenue_(aggr){
  const rows = aggr.monthlyFlat || [];
  const monthsSet = new Set();
  const chanSet = new Set(aggr.channelsList||[]);
  const map = new Map(); // key m\tch -> revenue
  rows.forEach(r=>{ const m=r[0], ch=r[1], rev=Number(r[4]||0); monthsSet.add(m); chanSet.add(ch); map.set(m+'\t'+ch, (map.get(m+'\t'+ch)||0)+rev); });
  const months = [...monthsSet].sort();
  const channels = [...chanSet].sort();
  return {
    months, channels,
    value: (m,ch)=> Number(map.get(m+'\t'+ch) || 0)
  };
}

/** ===== Ð¡Ñ‚Ð¸Ð»Ð¸ ===== */
function sectionTitle_(sh, row, col, text, width, bg, font){
  const w=Math.max(1,width||6); const rng=sh.getRange(row,col,1,w); try{rng.merge();}catch(e){}
  rng.setValue(String(text||''))
     .setFontFamily(font||'PT Sans')
     .setFontSize(13).setFontWeight('bold')
     .setHorizontalAlignment('left').setBackground(bg||'#E6F7FF');
  try{ rng.setBorder(null,null,true,null,false,false,'#4A90E2',SpreadsheetApp.BorderStyle.SOLID);}catch(e){}
}
function applyTableFrame_(rng, font){
  const sh=rng.getSheet(); const r=rng.getRow(), c=rng.getColumn(), nr=rng.getNumRows(), nc=rng.getNumColumns();
  rng.setFontFamily(font||'PT Sans');
  rng.setBorder(false,false,false,false,false,false);
  // Ð’Ð½ÐµÑˆÐ½ÑÑ Ñ‚Ð¾Ð½ÐºÐ°Ñ Ñ€Ð°Ð¼ÐºÐ°
  sh.getRange(r, c, 1, nc).setBorder(true,true,true,true,false,false,'#666666',SpreadsheetApp.BorderStyle.SOLID);
  sh.getRange(r+nr-1, c, 1, nc).setBorder(true,true,true,true,false,false,'#666666',SpreadsheetApp.BorderStyle.SOLID);
  sh.getRange(r, c, nr, 1).setBorder(true,true,true,true,false,false,'#666666',SpreadsheetApp.BorderStyle.SOLID);
  sh.getRange(r, c+nc-1, nr, 1).setBorder(true,true,true,true,false,false,'#666666',SpreadsheetApp.BorderStyle.SOLID);
  // ÐŸÑƒÐ½ÐºÑ‚Ð¸Ñ€Ð½Ð°Ñ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ ÑÐµÑ‚ÐºÐ°
  rng.setBorder(true,true,true,true,true,true,'#9E9E9E',SpreadsheetApp.BorderStyle.DOTTED);
}
function applyZebra_(rng){
  const sh=rng.getSheet(); const nr=rng.getNumRows(), nc=rng.getNumColumns();
  const dataRows = Math.max(0, nr-1);
  const odd='#F8FCFF', even='#FFFFFF';
  if (dataRows>0){ const dr=sh.getRange(rng.getRow()+1, rng.getColumn(), dataRows, nc); const bgs=[]; for(let i=0;i<dataRows;i++){ bgs.push(Array.from({length:nc},()=> (i%2===0?odd:even))); } dr.setBackgrounds(bgs); }
}
