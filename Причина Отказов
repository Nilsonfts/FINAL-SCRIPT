/*******************************************************************************
 * * –ù–ê–°–¢–†–û–ô–ö–ò –°–ö–†–ò–ü–¢–ê
 * *******************************************************************************/
const CONFIG = {
  // –ú–æ–¥–µ–ª–∏: –æ—Å–Ω–æ–≤–Ω–∞—è –∏ –∑–∞–ø–∞—Å–Ω–∞—è
  GPT_PRIMARY_MODEL:   'gpt-4o',
  GPT_FALLBACK_MODEL:  'gpt-4o-mini',

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è –ø—Ä–æ–º–ø—Ç–∞
  MAX_REASON_CLUSTERS:    70,
  MAX_EXAMPLES_PER_CAUSE: 4,
  MAX_PROMPT_CHARS:       10000,
  
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–û–ü-–ø—Ä–∏—á–∏–Ω –¥–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
  TOP_N_FOR_STACKED_CHART: 5,

  // –ù–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤ –∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
  SOURCE_SHEET: '–†–ê–ë–û–ß–ò–ô –ê–ú–û',
  OUTPUT_SHEET: '–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–æ–≤',
  TIMEZONE:     'Europe/Moscow',
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
  COLUMN_WIDTHS: {
    A: 40, B: 350, C: 80,
  }
};


/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–∞–∑–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É ¬´–ó–∞–∫—Ä—ã—Ç–æ –∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ¬ª
 */
function dailyReportWithGPT(){
  const OPENAI_API_KEY = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  if (!OPENAI_API_KEY) {
    throw new Error('–ö–ª—é—á "OPENAI_API_KEY" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –°–≤–æ–π—Å—Ç–≤–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ.');
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(CONFIG.SOURCE_SHEET);
  if (!sh) throw new Error(`–õ–∏—Å—Ç ¬´${CONFIG.SOURCE_SHEET}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω`);

  const {header, rows} = readTable_(sh);
  const i = detectAmoIndexes_(header);
  assertIndexes_(i, ['status','reason','created']);

  const items = rows.map(r=>({
    status:  norm_(r[i.status]),
    reason:  str(r[i.reason]),
    created: toDate_(r[i.created])
  }))
  .filter(x => isClosedLost_(x.status) && x.reason && x.created);

  const reasonsTable = calculateFrequency_(items.map(x=>x.reason));
  const monthlyTotal = calculateMonthlyBreakdown_(items);
  const monthlyReasons = calculateMonthlyReasonBreakdown_(items, reasonsTable);
  
  const compact = compactReasons_(items.map(x=>x.reason));
  const pieBlob = createPieChartImage_(compact);

  let prompt = buildDetailedAnalysisPrompt_(compact, items.length);
  if (prompt.length > CONFIG.MAX_PROMPT_CHARS) prompt = prompt.slice(0, CONFIG.MAX_PROMPT_CHARS);

  let gptText;
  try {
    gptText = callGPT_(OPENAI_API_KEY, prompt, CONFIG.GPT_PRIMARY_MODEL);
  } catch (e) {
    if (String(e).includes('429') || String(e).toLowerCase().includes('rate_limit')) {
      gptText = callGPT_(OPENAI_API_KEY, prompt, CONFIG.GPT_FALLBACK_MODEL);
    } else {
      throw e;
    }
  }

  writeOutSheet_(ss, reasonsTable, monthlyTotal, items.length, gptText, pieBlob, monthlyReasons);

  const subject = `üìä –ê–Ω–∞–ª–∏–∑ ${items.length} –æ—Ç–∫–∞–∑–æ–≤ (AMO) ‚Ä¢ ${Utilities.formatDate(new Date(), CONFIG.TIMEZONE, 'dd.MM.yyyy')}`;
  const htmlBody = formatReportAsHtml_(subject, gptText, monthlyTotal, 'pieChart');
  MailApp.sendEmail({
    to: Session.getActiveUser().getEmail(),
    subject,
    htmlBody,
    inlineImages: { pieChart: pieBlob }
  });
}

/** –°–æ–∑–¥–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä */
function createTriggerDaily_(){
  ScriptApp.getProjectTriggers()
    .filter(t=>t.getHandlerFunction()==='dailyReportWithGPT')
    .forEach(t=>ScriptApp.deleteTrigger(t));
  ScriptApp.newTrigger('dailyReportWithGPT').timeBased().atHour(9).everyDays(1).inTimezone(CONFIG.TIMEZONE).create();
  SpreadsheetApp.getUi().alert('–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–∫–∞–∑–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
}


/* ==================== –í–´–í–û–î –ù–ê –õ–ò–°–¢ ==================== */

function writeOutSheet_(ss, reasonsTable, monthly, total, gpt, pieBlob, monthlyReasons){
  const sh = ss.getSheetByName(CONFIG.OUTPUT_SHEET) || ss.insertSheet(CONFIG.OUTPUT_SHEET);
  sh.clear().setFrozenRows(2);
  
  sh.getCharts().forEach(chart => sh.removeChart(chart));

  sh.getRange(1,1,1,12).merge()
    .setValue('üìâ –û–¢–ö–ê–ó–´ (AMO) ‚Äî —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å ¬´–ó–∞–∫—Ä—ã—Ç–æ –∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ¬ª')
    .setBackground('#4285F4').setFontColor('white').setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');

  sh.getRange(2,1,1,4).setValues([
    ['–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ', new Date(), '–í—Å–µ–≥–æ –æ—Ç–∫–∞–∑–æ–≤', total]
  ]).setFontWeight('bold');
  sh.getRange(2,2).setNumberFormat('dd.MM.yyyy HH:mm');

  let r = 4;

  // –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏—á–∏–Ω
  sh.getRange(r,1,1,3).setValues([['#','–ü—Ä–∏—á–∏–Ω–∞','–ö–æ–ª-–≤–æ']]).setFontWeight('bold').setBackground('#f3f3f3'); r++;
  const body = reasonsTable.map((x,i)=>[i+1, x.reason, x.count]);
  if (body.length) sh.getRange(r,1,body.length,3).setValues(body);
  
  // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫-–ø–∏—Ä–æ–≥
  if (body.length > 0) {
    const chart = createEditablePieChart_(sh, r, body.length);
    sh.insertChart(chart);
  }

  r += Math.max(15, body.length) + 2;

  // –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (–æ–±—â–∞—è)
  sh.getRange(r,1,1,3).merge().setValue('–û–±—â–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –æ—Ç–∫–∞–∑–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º').setBackground('#FFF4C2').setFontWeight('bold'); r++;
  const mRows = Object.entries(monthly).sort((a,b)=>a[0].localeCompare(b[0]));
  if (mRows.length){
    sh.getRange(r,1,1,2).setValues([['–ú–µ—Å—è—Ü','–û—Ç–∫–∞–∑–æ–≤']]).setFontWeight('bold').setBackground('#f3f3f3'); r++;
    sh.getRange(r,1,mRows.length,2).setValues(mRows);
    r += mRows.length + 2;
  }
  
  // –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º
  sh.getRange(r,1,1,8).merge().setValue('–î–∏–Ω–∞–º–∏–∫–∞ –¢–û–ü-5 –ø—Ä–∏—á–∏–Ω –ø–æ –º–µ—Å—è—Ü–∞–º').setBackground('#FBBC04').setFontWeight('bold'); r++;
  const stackedChart = createStackedColumnChart_(sh, r, monthlyReasons);
  if(stackedChart) sh.insertChart(stackedChart);
  r += 18; // –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫

  // –¢–µ–∫—Å—Ç GPT
  sh.getRange(r,1,1,8).merge().setValue('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (GPT)').setBackground('#E9EEF6').setFontWeight('bold'); r++;
  sh.getRange(r, 1, 1, 8).merge()
    .setValue(gpt || '‚Äî')
    .setWrap(true)
    .setVerticalAlignment('top')
    .setBackground('#f8f9fa');
  
  formatSheetColumns_(sh);
}

/* ==================== –î–ê–ù–ù–´–ï –ò –ì–†–ê–§–ò–ö–ò ==================== */

function calculateFrequency_(reasons){
  const freqMap = new Map();
  reasons.forEach(r=>{
    const k = normReason_(r);
    if (!k) return;
    freqMap.set(k, (freqMap.get(k)||0)+1);
  });
  return [...freqMap.entries()]
    .sort((a,b)=>b[1]-a[1])
    .map(([reason,count])=>({reason,count}));
}

function calculateMonthlyReasonBreakdown_(items, reasonsTable) {
  const topReasons = reasonsTable.slice(0, CONFIG.TOP_N_FOR_STACKED_CHART).map(x => x.reason);
  const monthlyData = {};

  items.forEach(item => {
    const month = Utilities.formatDate(item.created, CONFIG.TIMEZONE, 'yyyy-MM');
    const reason = normReason_(item.reason);
    
    if (!monthlyData[month]) {
      monthlyData[month] = {};
      topReasons.forEach(tr => monthlyData[month][tr] = 0);
      monthlyData[month]['–ü—Ä–æ—á–∏–µ'] = 0;
    }
    
    const reasonKey = topReasons.includes(reason) ? reason : '–ü—Ä–æ—á–∏–µ';
    monthlyData[month][reasonKey]++;
  });
  return monthlyData;
}

function createEditablePieChart_(sheet, startDataRow, dataLength) {
  const numRows = Math.min(10, dataLength);
  const reasonsRange = sheet.getRange(startDataRow, 2, numRows);
  const countsRange = sheet.getRange(startDataRow, 3, numRows);
  return sheet.newChart()
    .asPieChart()
    .addRange(countsRange).addRange(reasonsRange)
    .setMergeStrategy(Charts.ChartMergeStrategy.MERGE_COLUMNS)
    .setOption('title', '–¢–û–ü-10 –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–∞–∑–∞')
    .setOption('is3D', true)
    .setOption('legend', { position: 'right' })
    .setPosition(4, 5, 0, 0)
    .build();
}

function createStackedColumnChart_(sheet, startChartRow, monthlyReasons) {
  const months = Object.keys(monthlyReasons).sort();
  if (months.length === 0) return null;

  const reasons = Object.keys(monthlyReasons[months[0]]);
  
  const chartData = [ ['–ú–µ—Å—è—Ü', ...reasons] ];
  months.forEach(month => {
    const row = [month, ...reasons.map(r => monthlyReasons[month][r] || 0)];
    chartData.push(row);
  });
  
  const dataSourceRange = sheet.getRange(startChartRow + 1, 1, chartData.length, chartData[0].length);
  dataSourceRange.setValues(chartData);
  sheet.hideRows(startChartRow + 1, chartData.length);

  return sheet.newChart()
    .asColumnChart()
    .addRange(dataSourceRange)
    .setMergeStrategy(Charts.ChartMergeStrategy.MERGE_COLUMNS)
    .setStacked()
    .setOption('title', '–î–∏–Ω–∞–º–∏–∫–∞ –¢–û–ü –ø—Ä–∏—á–∏–Ω –ø–æ –º–µ—Å—è—Ü–∞–º')
    .setOption('legend', { position: 'top', maxLines: 3 })
    .setOption('hAxis', { title: '–ú–µ—Å—è—Ü' })
    .setOption('vAxis', { title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–∞–∑–æ–≤' })
    .setPosition(startChartRow, 1, 0, 0)
    .build();
}

/* ==================== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï ==================== */

function formatSheetColumns_(sh) {
  sh.setColumnWidth(1, CONFIG.COLUMN_WIDTHS.A);
  sh.setColumnWidth(2, CONFIG.COLUMN_WIDTHS.B);
  sh.getRange('B:B').setWrap(true);
  sh.setColumnWidth(3, CONFIG.COLUMN_WIDTHS.C);
  sh.getRange('A:A').setHorizontalAlignment('center');
  sh.getRange('C:C').setHorizontalAlignment('center');
  sh.getRange(1, 1, sh.getMaxRows(), sh.getMaxColumns()).setFontFamily('Arial');
}

/* ==================== –ß–¢–ï–ù–ò–ï –ò –ü–û–ò–°–ö –ö–û–õ–û–ù–û–ö ==================== */

function readTable_(sh){
  const vals = sh.getDataRange().getValues();
  if (!vals.length) return {header:[],rows:[]};
  const headerRow = (vals[1] && vals[1].some(v=>String(v).trim()!=='')) ? 1 : 0;
  const header = (vals[headerRow]||[]).map(String);
  const rows    = vals.slice(headerRow+1).filter(r=>r.some(x=>String(x).trim()!==''));
  return {header, rows};
}

function detectAmoIndexes_(header){
  const H = header.map(h=>norm_(h));
  const find = (alts)=> H.findIndex(h => alts.map(norm_).some(w => h===w || h.includes(w)));
  return {
    status:  find(['—Å—Ç–∞—Ç—É—Å','—Å–¥–µ–ª–∫–∞.—Å—Ç–∞—Ç—É—Å']),
    reason:  find(['–ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–æ–±)','–ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']),
    created: find(['–¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è','date'])
  };
}

function assertIndexes_(idx, keys){
  const miss = keys.filter(k => idx[k]==null || idx[k]<0);
  if (miss.length){
    const dbg = Object.entries(idx).map(([k,v])=>`${k}:${v}`).join(', ');
    throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏: '+miss.join(', ')+' | –ù–∞–π–¥–µ–Ω–æ: '+dbg);
  }
}

/* ==================== –ü–û–î–°–ß–Å–¢–´ ==================== */

function calculateMonthlyBreakdown_(items){
  const monthly = {};
  items.forEach(x=>{
    const d = x.created instanceof Date ? x.created : toDate_(x.created);
    if (!d) return;
    const ym = Utilities.formatDate(d, CONFIG.TIMEZONE, 'yyyy-MM');
    monthly[ym] = (monthly[ym]||0)+1;
  });
  return monthly;
}

function compactReasons_(reasons){
  const freq = new Map();
  reasons.forEach(r=>{
    const k = normReason_(r);
    if (!k) return;
    freq.set(k, (freq.get(k)||0)+1);
  });
  const top = [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0, CONFIG.MAX_REASON_CLUSTERS);
  const exMap = new Map();
  top.forEach(([k])=>exMap.set(k, []));
  for (const r of reasons){
    const k = normReason_(r);
    if (!exMap.has(k)) continue;
    const arr = exMap.get(k);
    if (arr.length < CONFIG.MAX_EXAMPLES_PER_CAUSE) arr.push(r);
  }
  return top.map(([k,count])=>({reason:k, count, examples: exMap.get(k)||[]}));
}

/* ==================== GPT ==================== */

function callGPT_(apiKey, prompt, model){
  const url = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: model || CONFIG.GPT_PRIMARY_MODEL,
    temperature: 0.3,
    max_tokens: 2000,
    messages: [
      {role:'system', content:'–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –≥–ª—É–±–æ–∫–∏–µ –æ—Ç—á—ë—Ç—ã.'},
      {role:'user', content: prompt}
    ]
  };
  const resp = UrlFetchApp.fetch(url, {
    method:'post', contentType:'application/json', payload: JSON.stringify(payload),
    headers: { Authorization: `Bearer ${apiKey}` }, muteHttpExceptions:true
  });
  if (resp.getResponseCode()>=300){
    throw new Error('OpenAI –û—à–∏–±–∫–∞ '+resp.getResponseCode()+': '+resp.getContentText());
  }
  const data = JSON.parse(resp.getContentText());
  return data?.choices?.[0]?.message?.content?.trim() || '‚Äî';
}

function buildDetailedAnalysisPrompt_(compact,total){
  const lines = compact.map(c=>{
    const ex = c.examples?.length ? ` | –ü—Ä–∏–º–µ—Ä—ã: ¬´${c.examples.join('¬ª, ¬´')}¬ª` : '';
    return `‚Ä¢ ${c.reason} ‚Äî ${c.count}${ex}`;
  }).join('\n');
  return (
`–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –ø—Ä–æ–¥–∞–∂. –î–∞–Ω—ã –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–æ–≤ –∏–∑ CRM
(—Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞: ¬´–ó–∞–∫—Ä—ã—Ç–æ –∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ¬ª). –í—Å–µ–≥–æ –æ—Ç–∫–∞–∑–æ–≤: ${total}.
–ó–ê–î–ê–ß–ê:
1) –°–≥—Ä—É–ø–ø–∏—Ä—É–π –ø—Ä–∏—á–∏–Ω—ã –≤ 5‚Äì8 —Å–º—ã—Å–ª–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.
2) –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞: –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—É—Ç–∏, –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –∫–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã (2‚Äì3),
   –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (3‚Äì5): —Å–∫—Ä–∏–ø—Ç—ã/–ø—Ä–æ—Ü–µ—Å—Å—ã/SLA, –æ–±—É—á–µ–Ω–∏–µ, –æ—Ñ—Ñ–µ—Ä/—Ü–µ–Ω—ã, —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏, —Ç—Ä–∞—Ñ–∏–∫/UTM.
3) –ó–∞–≤–µ—Ä—à–∏ –±–ª–æ–∫–æ–º ¬´–ë—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã¬ª —Å 4‚Äì6 –ø—É–Ω–∫—Ç–∞–º–∏.
–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
${lines}`
  );
}

/* ==================== HTML-–ü–ò–°–¨–ú–û ==================== */

function createPieChartImage_(reasonsData){
  const dataTable = Charts.newDataTable()
    .addColumn(Charts.ColumnType.STRING, '–ü—Ä–∏—á–∏–Ω–∞')
    .addColumn(Charts.ColumnType.NUMBER, '–ö–æ–ª-–≤–æ');
  const top9 = reasonsData.slice(0,9);
  const other = reasonsData.slice(9).reduce((s,x)=>s+x.count,0);
  top9.forEach(x=>dataTable.addRow([x.reason, x.count]));
  if (other>0) dataTable.addRow(['–ü—Ä–æ—á–∏–µ', other]);
  const chart = Charts.newPieChart()
    .setDataTable(dataTable)
    .setOption('is3D', true)
    .setOption('legend', { position: 'right', textStyle: { fontSize: 12 } })
    .setOption('chartArea', {left: 20, top: 20, width: '100%', height: '90%'})
    .setDimensions(800, 500)
    .build();
  return chart.getBlob();
}

function formatReportAsHtml_(subject, gptText, monthlyData, chartCid){
  const gptHtml = markdownToHtml_(gptText);
  const monthlyHtml = formatMonthlyDataAsHtml_(monthlyData);
  return `
  <div style="font-family: Arial, sans-serif; line-height:1.6; color:#333; max-width:860px; margin:20px auto; padding:24px; border:1px solid #e5e5e5; border-radius:10px;">
    <h1 style="color:#1a73e8; border-bottom:2px solid #1a73e8; padding-bottom:10px; margin:0 0 16px;">${subject}</h1>
    <h2 style="margin-top:18px;">–¢–û–ü –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–∞–∑–∞ (–¥–∏–∞–≥—Ä–∞–º–º–∞)</h2>
    <div style="text-align:center; margin:10px 0 20px;">
      <img src="cid:${chartCid}" alt="Pie chart" style="max-width:100%; height:auto;">
    </div>
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –æ—Ç–∫–∞–∑–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
    ${monthlyHtml}
    <h2>–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –æ—Ç GPT</h2>
    <div style="background:#f8f9fa; padding:16px; border-radius:8px; white-space:pre-wrap;">${gptHtml}</div>
    <p style="text-align:center; color:#999; font-size:12px; margin-top:24px;">–û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
  </div>`;
}

function markdownToHtml_(text){
  if (!text) return '';
  return text
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/^\s*[-*‚Ä¢]\s+(.*)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .replace(/\n/g, '<br>');
}

function formatMonthlyDataAsHtml_(monthly){
  const entries = Object.entries(monthly).sort((a,b)=>a[0].localeCompare(b[0]));
  if (!entries.length) return '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</p>';
  const rows = entries.map(([m,c])=>`<tr><td style="padding:6px 10px;border:1px solid #eee;">${m}</td><td style="padding:6px 10px;border:1px solid #eee;">${c}</td></tr>`).join('');
  return `<table style="border-collapse:collapse; border:1px solid #eee; margin:8px 0;">
    <thead><tr><th style="padding:6px 10px;border:1px solid #eee;background:#fafafa;">–ú–µ—Å—è—Ü</th><th style="padding:6px 10px;border:1px solid #eee;background:#fafafa;">–û—Ç–∫–∞–∑–æ–≤</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

/* ==================== –£–¢–ò–õ–ò–¢–´ ==================== */

function toDate_(v){ if (v instanceof Date) return v; if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; }
function str(v){ return String(v==null?'':v).trim(); }
function norm_(s){ return String(s||'').toLowerCase().replace(/[‚ÇΩ,.;:()\-‚Äì‚Äî]/g,' ').replace(/\s+/g,' ').trim(); }
function normReason_(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
function isClosedLost_(status){ return /–∑–∞–∫—Ä—ã—Ç.*–Ω–µ.*—Ä–µ–∞–ª–∏–∑/i.test(String(status||'')); }
